/* This program simulates DDS local loop decoding algorithm B.
The B algorithm synchronizes alignment with the V bit.
This algorithm is a mess but it works perfectly.
At least two sequential CMI must be received to change alignment.
An isolated unaligned CMI is converted to 6 ones.
*/

#include <stdio.h>

long tdata, tbpv;

int se;

main()

{

	test("111x0v111x0v0000000111x0v111x0v111x0v010000000000111x0v");
	test("0111x0v111x0v000000111x0v111x0v111x0v010000000000111x0v");
	test("00111x0v111x0v00000111x0v111x0v111x0v010000000000111x0v");
	test("000111x0v111x0v0000111x0v111x0v111x0v010000000000111x0v");
	test("0000111x0v111x0v000111x0v111x0v111x0v010000000000111x0v");
	test("00000111x0v111x0v00111x0v111x0v111x0v010000000000111x0v");
	test("000000111x0v111x0v0111x0v111x0v111x0v010000000000111x0v");

	printf("\none unaligned cmi test\n");

	test("000000111x0v0100000000000000000000");
	test("0000000111x0v010000000000000000000");
	test("00000000111x0v01000000000000000000");
	test("000000000111x0v0100000000000000000");
	test("0000000000111x0v010000000000000000");
	test("00000000000111x0v01000000000000000");
	test("000000000000111x0v0100000000000000");

	printf("\ntwo unaligned cmi test\n");

	test("000000111x0v111x0v0100000000000000000000");
	test("0000000111x0v111x0v010000000000000000000");
	test("00000000111x0v111x0v01000000000000000000");
	test("000000000111x0v111x0v0100000000000000000");
	test("0000000000111x0v111x0v010000000000000000");
	test("00000000000111x0v111x0v01000000000000000");
	test("000000000000111x0v111x0v0100000000000000");

	printf("\ntwo cmi with 7 bits in between\n");

	test("000000111x0v0000000111x0v0100000000000000000000");
	test("0000000111x0v0000000111x0v010000000000000000000");
	test("00000000111x0v0000000111x0v01000000000000000000");
	test("000000000111x0v0000000111x0v0100000000000000000");
	test("0000000000111x0v0000000111x0v010000000000000000");
	test("00000000000111x0v0000000111x0v01000000000000000");
	test("000000000000111x0v0000000111x0v0100000000000000");

	printf("\nsequential cmi\n");

	test("111x0v111x0v111x0v111x0v010000000000000000");
	test("0111x0v111x0v111x0v111x0v01000000000000000");
	test("00111x0v111x0v111x0v111x0v0100000000000000");
	test("000111x0v111x0v111x0v111x0v010000000000000");
	test("0000111x0v111x0v111x0v111x0v01000000000000");
	test("00000111x0v111x0v111x0v111x0v0100000000000");
	test("000000111x0v111x0v111x0v111x0v010000000000");

	test("000000111x0v010000000000000000000000000000");
	test("0000000111x0v01000000000000000000000000000");
	test("00000000111x0v0100000000000000000000000000");
	test("000000000111x0v010000000000000000000000000");
	test("0000000000111x0v01000000000000000000000000");
	test("00000000000111x0v0100000000000000000000000");
	test("000000000000111x0v010000000000000000000000");

	test("000000111x0v111x0v010000000000000000000000");
	test("0000000111x0v111x0v01000000000000000000000");
	test("00000000111x0v111x0v0100000000000000000000");
	test("000000000111x0v111x0v010000000000000000000");
	test("0000000000111x0v111x0v01000000000000000000");
	test("00000000000111x0v111x0v0100000000000000000");
	test("000000000000111x0v111x0v010000000000000000");

	printf("\ntwo cmi with one bit in between\n");

	test("000000111x0v0111x0v01000000000000000000000");
	test("0000000111x0v0111x0v0100000000000000000000");
	test("00000000111x0v0111x0v010000000000000000000");
	test("000000000111x0v0111x0v01000000000000000000");
	test("0000000000111x0v0111x0v0100000000000000000");
	test("00000000000111x0v0111x0v010000000000000000");
	test("000000000000111x0v0111x0v01000000000000000");

	printf("\nloopback sequences\n");

	test("010x0v010000010x0v010000010x0v010000010x0v010000000000");
	test("0010x0v010000010x0v010000010x0v010000010x0v01000000000");
	test("00010x0v010000010x0v010000010x0v010000010x0v0100000000");
	test("000010x0v010000010x0v010000010x0v010000010x0v010000000");
	test("0000010x0v010000010x0v010000010x0v010000010x0v01000000");
	test("00000010x0v010000010x0v010000010x0v010000010x0v0100000");
	test("000000010x0v010000010x0v010000010x0v010000010x0v010000");

	printf("\nzero code\n");

	test("000x0v111111111111111111111111111111111111111111111111");
	test("1000x0v11111111111111111111111111111111111111111111111");
	test("11000x0v1111111111111111111111111111111111111111111111");
	test("111000x0v111111111111111111111111111111111111111111111");
	test("1111000x0v11111111111111111111111111111111111111111111");
	test("11111000x0v1111111111111111111111111111111111111111111");
	test("111111000x0v111111111111111111111111111111111111111111");

	printf("\nrun-on\n");

	test("111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0");
	test("111x0v00111x0v00111x0v00111x0v00111x0v00111x0v00111x0v00111x0v00111x0v00111x0v00");

}

test(s)

char *s;

{

	int i, n;

	printf("\n%s\n\n", s);

	tdata = 0;

	tbpv = 0;

	se = 0;

	n = strlen(s);

	for (i = 0; i < n; i++) {

		tdata <<= 1;

		tbpv <<= 1;

		switch (s[i]) {

		case '1':

		case 'x':

			tdata |= 1;

			break;

		case 'v':

			tdata |= 1;

			tbpv |= 1;

			break;

		}

		if (i % 6 == 5) {

			shift6();

			if (i > 5)

				send();

		}

	}

}

shift6()

{

	fix(5);

	fix(4);

	fix(3);

	fix(2);

	fix(1);

	fix(0);

/*	debug(); */

}

fix(n)

int n;

{

	if ((tbpv & 1 << n) && (tdata & 0x3b << n) == (0x01 << n))

		tdata &= ~(0x3f << n);

	if ((tbpv & 1 << n) && (tdata & 0x3b << n) == (0x39 << n) && se != n) {

		/* check for cmi last time */

		if ((tbpv & 1L << (n + 6)) && (tdata & 0x3fL << (n + 6)) == (0x3fL << (n + 6))) {

			/* put first cmi back */

			tdata &= ~(0x3f << (n + 6));

			tdata |= (0x39 << (n + 6));

			/* change alignment */

			se = n;

		} else {

/*			debug(); */

			/* replace cmi with 6 ones */

			tdata |= 0x3f << n;

		}

	}

	if ((tbpv & 1 << n) && (tdata & 0x3b << n) == (0x11 << n) && se != n) {

		/* replace loop code with 6 ones */

		tdata |= 0x3f << n;

		/* change alignment */

		se = n;

	}

}

send()

{

	int i;

	long ydata, ybpv;

/*	debug(); */

	ydata = tdata >> (se + 6);

	ybpv = tbpv >> (se + 6);

	if ((ybpv & 0x01) && (ydata & 0x3b) == 0x39)

		printf("11111110 (cmi)\n");

	else if ((ybpv & 0x01) && (ydata & 0x3b) == 0x11)

		printf("10101100 (loop)\n");

	else {

		printf("1");

		for (i = 0; i < 6; i++) {

			if (ydata & 0x20)

				printf("1");
			else

				printf("0");

			ydata <<= 1;

		}

		printf("1\n");

	}

}

print18(n)

long n;

{

	int i;

	for (i = 0; i < 18; i++) {

		if (n & 0x40000)

			printf("1");

		else

			printf("0");

		n <<= 1;

	}

}

debug()

{

	printf("tdata = ");

	print18(tdata);

	printf("\n");

	printf("tbpv  = ");

	print18(tbpv);

	printf("\n");

	printf("se = %d\n", se);

}

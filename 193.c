/* DES demonstration code. */


#include <stdio.h>
#include <stdlib.h>

int s1[64] = {
 14,  0,  4, 15, 13,  7,  1,  4,
  2, 14, 15,  2, 11, 13,  8,  1,
  3, 10, 10,  6,  6, 12, 12, 11,
  5,  9,  9,  5,  0,  3,  7,  8,
  4, 15,  1, 12, 14,  8,  8,  2,
 13,  4,  6,  9,  2,  1, 11,  7,
 15,  5, 12, 11,  9,  3,  7, 14,
  3, 10, 10,  0,  5,  6,  0, 13,
};

int s2[64] = {
 15,  3,  1, 13,  8,  4, 14,  7,
  6, 15, 11,  2,  3,  8,  4, 14,
  9, 12,  7,  0,  2,  1, 13, 10,
 12,  6,  0,  9,  5, 11, 10,  5,
  0, 13, 14,  8,  7, 10, 11,  1,
 10,  3,  4, 15, 13,  4,  1,  2,
  5, 11,  8,  6, 12,  7,  6, 12,
  9,  0,  3,  5,  2, 14, 15,  9,
};

int s3[64] = {
 10, 13,  0,  7,  9,  0, 14,  9,
  6,  3,  3,  4, 15,  6,  5, 10,
  1,  2, 13,  8, 12,  5,  7, 14,
 11, 12,  4, 11,  2, 15,  8,  1,
 13,  1,  6, 10,  4, 13,  9,  0,
  8,  6, 15,  9,  3,  8,  0,  7,
 11,  4,  1, 15,  2, 14, 12,  3,
  5, 11, 10,  5, 14,  2,  7, 12,
};

int s4[64] = {
  7, 13, 13,  8, 14, 11,  3,  5,
  0,  6,  6, 15,  9,  0, 10,  3,
  1,  4,  2,  7,  8,  2,  5, 12,
 11,  1, 12, 10,  4, 14, 15,  9,
 10,  3,  6, 15,  9,  0,  0,  6,
 12, 10, 11,  1,  7, 13, 13,  8,
 15,  9,  1,  4,  3,  5, 14, 11,
  5, 12,  2,  7,  8,  2,  4, 14,
};

int s5[64] = {
  2, 14, 12, 11,  4,  2,  1, 12,
  7,  4, 10,  7, 11, 13,  6,  1,
  8,  5,  5,  0,  3, 15, 15, 10,
 13,  3,  0,  9, 14,  8,  9,  6,
  4, 11,  2,  8,  1, 12, 11,  7,
 10,  1, 13, 14,  7,  2,  8, 13,
 15,  6,  9, 15, 12,  0,  5,  9,
  6, 10,  3,  4,  0,  5, 14,  3,
};

int s6[64] = {
 12, 10,  1, 15, 10,  4, 15,  2,
  9,  7,  2, 12,  6,  9,  8,  5,
  0,  6, 13,  1,  3, 13,  4, 14,
 14,  0,  7, 11,  5,  3, 11,  8,
  9,  4, 14,  3, 15,  2,  5, 12,
  2,  9,  8,  5, 12, 15,  3, 10,
  7, 11,  0, 14,  4,  1, 10,  7,
  1,  6, 13,  0, 11,  8,  6, 13,
};

int s7[64] = {
  4, 13, 11,  0,  2, 11, 14,  7,
 15,  4,  0,  9,  8,  1, 13, 10,
  3, 14, 12,  3,  9,  5,  7, 12,
  5,  2, 10, 15,  6,  8,  1,  6,
  1,  6,  4, 11, 11, 13, 13,  8,
 12,  1,  3,  4,  7, 10, 14,  7,
 10,  9, 15,  5,  6,  0,  8, 15,
  0, 14,  5,  2,  9,  3,  2, 12,
};

int s8[64] = {
 13,  1,  2, 15,  8, 13,  4,  8,
  6, 10, 15,  3, 11,  7,  1,  4,
 10, 12,  9,  5,  3,  6, 14, 11,
  5,  0,  0, 14, 12,  9,  7,  2,
  7,  2, 11,  1,  4, 14,  1,  7,
  9,  4, 12, 10, 14,  8,  2, 13,
  0, 15,  6, 12, 10,  9, 13,  0,
 15,  3,  3,  5,  5,  6,  8, 11,
};

unsigned char key[8], x[8], y[8], r[4], l[4], f[4], c[4], d[4], t[8], ks[16][6];

main()
{
	int i;

	key[0] = 0x01;
	key[1] = 0x01;
	key[2] = 0x01;
	key[3] = 0x01;
	key[4] = 0x01;
	key[5] = 0x01;
	key[6] = 0x01;
	key[7] = 0x01;

	x[0] = 0x80;
	x[1] = 0x00;
	x[2] = 0x00;
	x[3] = 0x00;
	x[4] = 0x00;
	x[5] = 0x00;
	x[6] = 0x00;
	x[7] = 0x00;

	mks();

	encrypt();

	printf("%02x %02x %02x %02x %02x %02x %02x %02x\n", y[0], y[1], y[2], y[3], y[4], y[5], y[6], y[7]);

	decrypt();

	printf("%02x %02x %02x %02x %02x %02x %02x %02x\n", x[0], x[1], x[2], x[3], x[4], x[5], x[6], x[7]);

	test();
}

test()
{
	int i, j;
	unsigned char tmp[8];

	for (i = 0; i < 10000; i++) {

		fprintf(stderr, ".");

		for (j = 0; j < 8; j++) {
			x[j] = random();
			tmp[j] = x[j];
			key[j] = random();
		}

		mks();

		encrypt();

		for (j = 0; j < 8; j++)
			x[j] = 0;

		decrypt();

		for (j = 0; j < 8; j++)
			if (tmp[j] != x[j]) {
				printf("test failed\n");
				exit(1);
			}
	}

	printf("test passed\n");
}

encrypt()
{
	int i;

	initial_permutation(x);

	for (i = 0; i < 16; i++) {

		frk(i);

		t[0] = r[0];
		t[1] = r[1];
		t[2] = r[2];
		t[3] = r[3];

		r[0] = l[0] ^ f[0];
		r[1] = l[1] ^ f[1];
		r[2] = l[2] ^ f[2];
		r[3] = l[3] ^ f[3];

		l[0] = t[0];
		l[1] = t[1];
		l[2] = t[2];
		l[3] = t[3];
	}

	final_permutation(y);
}

decrypt()
{
	int i;

	initial_permutation(y);

	for (i = 0; i < 16; i++) {

		frk(15 - i);

		t[0] = r[0];
		t[1] = r[1];
		t[2] = r[2];
		t[3] = r[3];

		r[0] = l[0] ^ f[0];
		r[1] = l[1] ^ f[1];
		r[2] = l[2] ^ f[2];
		r[3] = l[3] ^ f[3];

		l[0] = t[0];
		l[1] = t[1];
		l[2] = t[2];
		l[3] = t[3];
	}

	final_permutation(x);
}

#undef F 

#define F(m, n) if (p[(n - 1) / 8] & (0x80 >> ((n - 1) % 8))) l[(m - 1) / 8] |= (0x80 >> ((m - 1) % 8));

#undef G 

#define G(m, n) if (p[(n - 1) / 8] & (0x80 >> ((n - 1) % 8))) r[(m - 33) / 8] |= (0x80 >> ((m - 33) % 8));

initial_permutation(unsigned char *p)
{
	l[0] = 0;
	l[1] = 0;
	l[2] = 0;
	l[3] = 0;

	r[0] = 0;
	r[1] = 0;
	r[2] = 0;
	r[3] = 0;

	F( 1, 58)
	F( 2, 50)
	F( 3, 42)
	F( 4, 34)
	F( 5, 26)
	F( 6, 18)
	F( 7, 10)
	F( 8,  2)

	F( 9, 60)
	F(10, 52)
	F(11, 44)
	F(12, 36)
	F(13, 28)
	F(14, 20)
	F(15, 12)
	F(16,  4)

	F(17, 62)
	F(18, 54)
	F(19, 46)
	F(20, 38)
	F(21, 30)
	F(22, 22)
	F(23, 14)
	F(24,  6)

	F(25, 64)
	F(26, 56)
	F(27, 48)
	F(28, 40)
	F(29, 32)
	F(30, 24)
	F(31, 16)
	F(32,  8)

	G(33, 57)
	G(34, 49)
	G(35, 41)
	G(36, 33)
	G(37, 25)
	G(38, 17)
	G(39,  9)
	G(40,  1)

	G(41, 59)
	G(42, 51)
	G(43, 43)
	G(44, 35)
	G(45, 27)
	G(46, 19)
	G(47, 11)
	G(48,  3)

	G(49, 61)
	G(50, 53)
	G(51, 45)
	G(52, 37)
	G(53, 29)
	G(54, 21)
	G(55, 13)
	G(56,  5)

	G(57, 63)
	G(58, 55)
	G(59, 47)
	G(60, 39)
	G(61, 31)
	G(62, 23)
	G(63, 15)
	G(64,  7)
}

/* note: r is on the left, l is on the right */

#undef F

#define F(m, n) if (r[(n - 1) / 8] & (0x80 >> ((n - 1) % 8))) p[(m - 1) / 8] |= (0x80 >> ((m - 1) % 8));

#undef G

#define G(m, n) if (l[(n - 33) / 8] & (0x80 >> ((n - 33) % 8))) p[(m - 1) / 8] |= (0x80 >> ((m - 1) % 8));

final_permutation(unsigned char *p)
{
	p[0] = 0;
	p[1] = 0;
	p[2] = 0;
	p[3] = 0;
	p[4] = 0;
	p[5] = 0;
	p[6] = 0;
	p[7] = 0;

	G( 1, 40)
	F( 2,  8)
	G( 3, 48)
	F( 4, 16)
	G( 5, 56)
	F( 6, 24)
	G( 7, 64)
	F( 8, 32)

	G( 9, 39)
	F(10,  7)
	G(11, 47)
	F(12, 15)
	G(13, 55)
	F(14, 23)
	G(15, 63)
	F(16, 31)

	G(17, 38)
	F(18,  6)
	G(19, 46)
	F(20, 14)
	G(21, 54)
	F(22, 22)
	G(23, 62)
	F(24, 30)

	G(25, 37)
	F(26,  5)
	G(27, 45)
	F(28, 13)
	G(29, 53)
	F(30, 21)
	G(31, 61)
	F(32, 29)

	G(33, 36)
	F(34,  4)
	G(35, 44)
	F(36, 12)
	G(37, 52)
	F(38, 20)
	G(39, 60)
	F(40, 28)

	G(41, 35)
	F(42,  3)
	G(43, 43)
	F(44, 11)
	G(45, 51)
	F(46, 19)
	G(47, 59)
	F(48, 27)

	G(49, 34)
	F(50,  2)
	G(51, 42)
	F(52, 10)
	G(53, 50)
	F(54, 18)
	G(55, 58)
	F(56, 26)

	G(57, 33)
	F(58,  1)
	G(59, 41)
	F(60,  9)
	G(61, 49)
	F(62, 17)
	G(63, 57)
	F(64, 25)
}

/*
 * 	f(R, K)
 *
 *	input:		r (32 bits), k (48 bits)
 *
 *	output:		f (32 bits)
 */

#define R(n) ((r[(n - 1) / 8] & (0x80 >> ((n - 1) % 8))) ? 1 : 0)

#define K(m) ((ks[j][(m - 1) / 8] & (0x80 >> ((m - 1) % 8))) ? 1 : 0)

#undef F

#define F(m, n)	if (R(n) != K(m)) t[(m - 1) / 6] |= (0x20 >> ((m - 1) % 6));

#undef G

#define G(m, n)	if (t[(n - 1) / 4] & (0x8 >> ((n - 1) % 4))) f[(m - 1) / 8] |= (0x80 >> ((m - 1) % 8));

frk(int j)
{
	t[0] = 0;
	t[1] = 0;
	t[2] = 0;
	t[3] = 0;
	t[4] = 0;
	t[5] = 0;
	t[6] = 0;
	t[7] = 0;

	F( 1, 32)
	F( 2,  1)
	F( 3,  2)
	F( 4,  3)
	F( 5,  4)
	F( 6,  5)

	F( 7,  4)
	F( 8,  5)
	F( 9,  6)
	F(10,  7)
	F(11,  8)
	F(12,  9)

	F(13,  8)
	F(14,  9)
	F(15, 10)
	F(16, 11)
	F(17, 12)
	F(18, 13)

	F(19, 12)
	F(20, 13)
	F(21, 14)
	F(22, 15)
	F(23, 16)
	F(24, 17)

	F(25, 16)
	F(26, 17)
	F(27, 18)
	F(28, 19)
	F(29, 20)
	F(30, 21)

	F(31, 20)
	F(32, 21)
	F(33, 22)
	F(34, 23)
	F(35, 24)
	F(36, 25)

	F(37, 24)
	F(38, 25)
	F(39, 26)
	F(40, 27)
	F(41, 28)
	F(42, 29)

	F(43, 28)
	F(44, 29)
	F(45, 30)
	F(46, 31)
	F(47, 32)
	F(48,  1)

	t[0] = s1[t[0]];
	t[1] = s2[t[1]];
	t[2] = s3[t[2]];
	t[3] = s4[t[3]];
	t[4] = s5[t[4]];
	t[5] = s6[t[5]];
	t[6] = s7[t[6]];
	t[7] = s8[t[7]];

	f[0] = 0;
	f[1] = 0;
	f[2] = 0;
	f[3] = 0;

	G( 1, 16)
	G( 2,  7)
	G( 3, 20)
	G( 4, 21)

	G( 5, 29)
	G( 6, 12)
	G( 7, 28)
	G( 8, 17)

	G( 9,  1)
	G(10, 15)
	G(11, 23)
	G(12, 26)

	G(13,  5)
	G(14, 18)
	G(15, 31)
	G(16, 10)

	G(17,  2)
	G(18,  8)
	G(19, 24)
	G(20, 14)

	G(21, 32)
	G(22, 27)
	G(23,  3)
	G(24,  9)

	G(25, 19)
	G(26, 13)
	G(27, 30)
	G(28,  6)

	G(29, 22)
	G(30, 11)
	G(31,  4)
	G(32, 25)
}

/* make key schedule */

mks()
{
	int i;

	permuted_choice_1();

	for (i = 0; i < 16; i++) {

		if (i == 0 || i == 1 || i == 8 || i == 15)
			left_shift();
		else {
			left_shift();
			left_shift();
		}

		permuted_choice_2(i);
	}
}

left_shift()
{
	int tmp;

	tmp = c[0];

	c[0] <<= 1;
	if (c[1] & 0x80)
		c[0] |= 1;

	c[1] <<= 1;
	if (c[2] & 0x80)
		c[1] |= 1;

	c[2] <<= 1;
	if (c[3] & 0x80)
		c[2] |= 1;

	c[3] <<= 1;
	if (tmp & 0x80)
		c[3] |= 0x10;

	tmp = d[0];

	d[0] <<= 1;
	if (d[1] & 0x80)
		d[0] |= 1;

	d[1] <<= 1;
	if (d[2] & 0x80)
		d[1] |= 1;

	d[2] <<= 1;
	if (d[3] & 0x80)
		d[2] |= 1;

	d[3] <<= 1;
	if (tmp & 0x80)
		d[3] |= 0x10;
}

/*
 * Permuted Choice 1
 *
 *	input:		key (56 bits)
 *
 *	output:		c, d (28 bits each)
 */

#undef F

#define F(m, n) if (key[(n - 1) / 8] & (0x80 >> ((n - 1) % 8))) c[(m - 1) / 8] |= (0x80 >> ((m - 1) % 8));

#undef G

#define G(m, n) if (key[(n - 1) / 8] & (0x80 >> ((n - 1) % 8))) d[(m - 1) / 8] |= (0x80 >> ((m - 1) % 8));

permuted_choice_1()
{
	c[0] = 0;
	c[1] = 0;
	c[2] = 0;
	c[3] = 0;

	d[0] = 0;
	d[1] = 0;
	d[2] = 0;
	d[3] = 0;

	F( 1, 57)
	F( 2, 49)
	F( 3, 41)
	F( 4, 33)
	F( 5, 25)
	F( 6, 17)
	F( 7,  9)

	F( 8,  1)
	F( 9, 58)
	F(10, 50)
	F(11, 42)
	F(12, 34)
	F(13, 26)
	F(14, 18)

	F(15, 10)
	F(16,  2)
	F(17, 59)
	F(18, 51)
	F(19, 43)
	F(20, 35)
	F(21, 27)

	F(22, 19)
	F(23, 11)
	F(24,  3)
	F(25, 60)
	F(26, 52)
	F(27, 44)
	F(28, 36)

	G( 1, 63)
	G( 2, 55)
	G( 3, 47)
	G( 4, 39)
	G( 5, 31)
	G( 6, 23)
	G( 7, 15)

	G( 8,  7)
	G( 9, 62)
	G(10, 54)
	G(11, 46)
	G(12, 38)
	G(13, 30)
	G(14, 22)

	G(15, 14)
	G(16,  6)
	G(17, 61)
	G(18, 53)
	G(19, 45)
	G(20, 37)
	G(21, 29)

	G(22, 21)
	G(23, 13)
	G(24,  5)
	G(25, 28)
	G(26, 20)
	G(27, 12)
	G(28,  4)
}

/*
 * Permuted Choice 2
 *
 *	input:		c, d (28 bits each)
 *
 *	output:		ks[i] (48 bits)
 */

#undef F

#define F(m, n) if (c[(n - 1) / 8] & (0x80 >> ((n - 1) % 8))) ks[i][(m - 1) / 8] |= (0x80 >> ((m - 1) % 8));

#undef G

#define G(m, n) if (d[(n - 29) / 8] & (0x80 >> ((n - 29) % 8))) ks[i][(m - 1) / 8] |= (0x80 >> ((m - 1) % 8));

permuted_choice_2(int i)
{
	ks[i][0] = 0;
	ks[i][1] = 0;
	ks[i][2] = 0;
	ks[i][3] = 0;
	ks[i][4] = 0;
	ks[i][5] = 0;

	F( 1, 14)
	F( 2, 17)
	F( 3, 11)
	F( 4, 24)
	F( 5,  1)
	F( 6,  5)

	F( 7,  3)
	F( 8, 28)
	F( 9, 15)
	F(10,  6)
	F(11, 21)
	F(12, 10)

	F(13, 23)
	F(14, 19)
	F(15, 12)
	F(16,  4)
	F(17, 26)
	F(18,  8)

	F(19, 16)
	F(20,  7)
	F(21, 27)
	F(22, 20)
	F(23, 13)
	F(24,  2)

	G(25, 41)
	G(26, 52)
	G(27, 31)
	G(28, 37)
	G(29, 47)
	G(30, 55)

	G(31, 30)
	G(32, 40)
	G(33, 51)
	G(34, 45)
	G(35, 33)
	G(36, 48)

	G(37, 44)
	G(38, 49)
	G(39, 39)
	G(40, 56)
	G(41, 34)
	G(42, 53)

	G(43, 46)
	G(44, 42)
	G(45, 50)
	G(46, 36)
	G(47, 29)
	G(48, 32)
}

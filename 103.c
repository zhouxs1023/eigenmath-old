/* This program simulates DDS local loop decoding algorithm D. */

#include <stdio.h>

unsigned int tdata, tbpv;

unsigned long rdata, rbpv;

int k;

main()

{

	test("111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0");

	test("111x0v111x0v0111x0v111x0v0111x0v111x0v0111x0v111x0v0111x0v111x0v0111x0v111x0v0111x0v111x0v0111x0v111x0v0111x0v111x0v0111x0v111x0v");

	test("111x0v111x0v0000000111x0v111x0v111x0v010000000000111x0v");
	test("0111x0v111x0v000000111x0v111x0v111x0v010000000000111x0v");
	test("00111x0v111x0v00000111x0v111x0v111x0v010000000000111x0v");
	test("000111x0v111x0v0000111x0v111x0v111x0v010000000000111x0v");
	test("0000111x0v111x0v000111x0v111x0v111x0v010000000000111x0v");
	test("00000111x0v111x0v00111x0v111x0v111x0v010000000000111x0v");
	test("000000111x0v111x0v0111x0v111x0v111x0v010000000000111x0v");

	printf("\none unaligned cmi test\n");

	test("000000000010111x0v010000000000000000000000111111000000000000");
	test("0000000000010111x0v01000000000000000000000111111000000000000");
	test("00000000000010111x0v0100000000000000000000111111000000000000");
	test("000000000000010111x0v010000000000000000000111111000000000000");
	test("0000000000000010111x0v01000000000000000000111111000000000000");
	test("00000000000000010111x0v0100000000000000000111111000000000000");
	test("000000000000000010111x0v010000000000000000111111000000000000");

	printf("\ntwo unaligned cmi test\n");

	test("000000111x0v111x0v0100000000000000000000");
	test("0000000111x0v111x0v010000000000000000000");
	test("00000000111x0v111x0v01000000000000000000");
	test("000000000111x0v111x0v0100000000000000000");
	test("0000000000111x0v111x0v010000000000000000");
	test("00000000000111x0v111x0v01000000000000000");
	test("000000000000111x0v111x0v0100000000000000");

	printf("\ncmi fields with 6 bits in between\n");

	test("000000111x0v111x0v000000111x0v111x0v01000000000000000000000");
	test("0000000111x0v111x0v000000111x0v111x0v0100000000000000000000");
	test("00000000111x0v111x0v000000111x0v111x0v010000000000000000000");
	test("000000000111x0v111x0v000000111x0v111x0v01000000000000000000");
	test("0000000000111x0v111x0v000000111x0v111x0v0100000000000000000");
	test("00000000000111x0v111x0v000000111x0v111x0v010000000000000000");
	test("000000000000111x0v111x0v000000111x0v111x0v01000000000000000");

	printf("\ncmi fields with 7 bits in between\n");

	test("000000111x0v111x0v0000000111x0v111x0v0100000000000000000000");
	test("0000000111x0v111x0v0000000111x0v111x0v010000000000000000000");
	test("00000000111x0v111x0v0000000111x0v111x0v01000000000000000000");
	test("000000000111x0v111x0v0000000111x0v111x0v0100000000000000000");
	test("0000000000111x0v111x0v0000000111x0v111x0v010000000000000000");
	test("00000000000111x0v111x0v0000000111x0v111x0v01000000000000000");
	test("000000000000111x0v111x0v0000000111x0v111x0v0100000000000000");

	printf("\nsequential cmi\n");

	test("111x0v111x0v111x0v111x0v010000000000000000");
	test("0111x0v111x0v111x0v111x0v01000000000000000");
	test("00111x0v111x0v111x0v111x0v0100000000000000");
	test("000111x0v111x0v111x0v111x0v010000000000000");
	test("0000111x0v111x0v111x0v111x0v01000000000000");
	test("00000111x0v111x0v111x0v111x0v0100000000000");
	test("000000111x0v111x0v111x0v111x0v010000000000");

	test("000000111x0v010000000000000000000000000000");
	test("0000000111x0v01000000000000000000000000000");
	test("00000000111x0v0100000000000000000000000000");
	test("000000000111x0v010000000000000000000000000");
	test("0000000000111x0v01000000000000000000000000");
	test("00000000000111x0v0100000000000000000000000");
	test("000000000000111x0v010000000000000000000000");

	test("000000111x0v111x0v010000000000000000000000");
	test("0000000111x0v111x0v01000000000000000000000");
	test("00000000111x0v111x0v0100000000000000000000");
	test("000000000111x0v111x0v010000000000000000000");
	test("0000000000111x0v111x0v01000000000000000000");
	test("00000000000111x0v111x0v0100000000000000000");
	test("000000000000111x0v111x0v010000000000000000");

	printf("\ntwo cmi with one bit in between\n");

	test("000000111x0v0111x0v01000000000000000000000");
	test("0000000111x0v0111x0v0100000000000000000000");
	test("00000000111x0v0111x0v010000000000000000000");
	test("000000000111x0v0111x0v01000000000000000000");
	test("0000000000111x0v0111x0v0100000000000000000");
	test("00000000000111x0v0111x0v010000000000000000");
	test("000000000000111x0v0111x0v01000000000000000");

	printf("\nloopback sequences\n");

	test("010x0v010000010x0v010000010x0v010000010x0v010000000000");
	test("0010x0v010000010x0v010000010x0v010000010x0v01000000000");
	test("00010x0v010000010x0v010000010x0v010000010x0v0100000000");
	test("000010x0v010000010x0v010000010x0v010000010x0v010000000");
	test("0000010x0v010000010x0v010000010x0v010000010x0v01000000");
	test("00000010x0v010000010x0v010000010x0v010000010x0v0100000");
	test("000000010x0v010000010x0v010000010x0v010000010x0v010000");

	printf("\nzero code\n");

	test("000x0v111111111111111111111111111111111111111111111111");
	test("1000x0v11111111111111111111111111111111111111111111111");
	test("11000x0v1111111111111111111111111111111111111111111111");
	test("111000x0v111111111111111111111111111111111111111111111");
	test("1111000x0v11111111111111111111111111111111111111111111");
	test("11111000x0v1111111111111111111111111111111111111111111");
	test("111111000x0v111111111111111111111111111111111111111111");

	printf("\nrun-on\n");

	test("111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0111x0v0");
	test("111x0v00111x0v00111x0v00111x0v00111x0v00111x0v00111x0v00111x0v00111x0v00111x0v00");

}

test(s)

char *s;

{

	int i, n;

	printf("\n%s\n\n", s);

	k = 0;

	rdata = 0;

	rbpv = 0;

	tdata = 0;

	tbpv = 0;

	n = strlen(s);

	for (i = 0; i < n; i++) {

		tdata <<= 1;

		tbpv <<= 1;

		switch (s[i]) {

		case '1':

		case 'x':

			tdata |= 1;

			break;

		case 'v':

			tdata |= 1;

			tbpv |= 1;

			break;

		}

		if (i % 6 == 5)

			shift6();

	}

}

shift6()

{

	rdata = rdata << 6 | tdata & 0x3f;

	rbpv = rbpv << 6 | tbpv & 0x3f;

	if (decode(5) == 0)

		if (decode(4) == 0)

			if (decode(3) == 0)

				if (decode(2) == 0)

					if (decode(1) == 0)

						decode(0);

	send();

}

decode(n)

int n;

{

	if (rbpv >> n & 1)

		switch (rdata >> n & 0x3b) {

		/* zero */

		case 0x01:

			rdata &= ~(long) (0x3f << n);

			rbpv &= ~(long) 1 << n;

			return 1;

		/* cmi */

		case 0x39:

			rdata |= 0x3f << n;

			return 1;

		/* loop */

		case 0x11:

			rdata &= ~(long) (0x3f << n);

			rdata |= 0x16 << n;

			return 1;

		default:

			return 0;

		}

}

send()

{

	int i;

	unsigned int ydata, ybpv;

	ydata = rdata >> (k + 6) & 0x3f;

	ybpv = rbpv >> (k + 6) & 0x3f;

	switch (ybpv) {

	case 0x02:

		k += 1;

		break;

	case 0x04:

		k += 2;

		break;

	case 0x08:

		k += 3;

		break;

	case 0x10:

		k += 4;

		break;

	case 0x20:

		k += 5;

		break;

	}

	if (k >= 6)

		k -= 6;

	ydata = rdata >> (k + 6) & 0x3f;

	ybpv = rbpv >> (k + 6) & 0x3f;

	if (ybpv == 0x01) {

		if (ydata == 0x3f)

			printf("11111110 (cmi)\n");

		else

			printf("10101100 (loop)\n");

	} else {

		printf("1");

		for (i = 0; i < 6; i++) {

			if (ydata & 0x20)

				printf("1");

			else

				printf("0");

			ydata <<= 1;

		}

		printf("1\n");

	}

}

print12(n)

unsigned int n;

{

	int i;

	for (i = 0; i < 12; i++) {

		if (n & 0x800)

			printf("1");

		else

			printf("0");

		n <<= 1;

	}

}

debug()

{

	printf("rdata = ");

	print12(rdata);

	printf("\n");

	printf("rbpv  = ");

	print12(rbpv);

	printf("\n");

	printf("k = %d\n", k);

}

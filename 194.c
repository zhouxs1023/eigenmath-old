/* ethernet FCS calculation */

/* sample packet */

unsigned char buf[256] = {
	0x00,0x06,0x2c,0x00,0x1f,0x7b,0x00,0x00,
	0x00,0x00,0x00,0x01,0x08,0x00,0x45,0x00,
	0x00,0xf2,0x00,0x00,0x00,0x00,0x40,0x11,
	0x76,0xf8,0x02,0x00,0x00,0x02,0x01,0x00,
	0x00,0x02,0x00,0x02,0x00,0x02,0x00,0xde,
	0xfb,0x2a,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,
};

/* G(x) = x^32 + x^26 + x^23 + x^22 + x^16
+ x^12 + x^11 + x^10 + x^8 + x^7 + x^5 + x^4
+ x^2 + x + 1 */

/* G is reflected (bit 0 corresponds to x^31) */

#define G 0xedb88320

main()
{
	unsigned int i, j, r;

	/* first four bytes of packet */

	r = (unsigned int) buf[0]
	  | (unsigned int) buf[1] << 8
	  | (unsigned int) buf[2] << 16
	  | (unsigned int) buf[3] << 24;

	r = ~r; /* invert first 32 bits */

	for (i = 4; i < 256; i++) {

		/* shift 8 bits */

		for (j = 0; j < 8; j++)
			if (r & 1)
				r = (r >> 1) ^ G;
			else
				r >>= 1;

		/* fix up last 8 bits */

		r ^= (unsigned int) buf[i] << 24;
	}

	/* shift in 32 zero bits */

	for (i = 0; i < 32; i++)
		if (r & 1)
			r = (r >> 1) ^ G;
		else
			r >>= 1;

	r = ~r; /* invert result */

	if (htonl(r) == 0x9639506d)
		printf("ok\n");
	else
		printf("error\n");

	printf("FCS = %02x %02x %02x %02x\n",
		r & 0xff, /* 1st byte sent */
		r >> 8 & 0xff,
		r >> 16 & 0xff,
		r >> 24);
}
